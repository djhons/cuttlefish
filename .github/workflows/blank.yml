name: Build and Upload Cuttlefish (Ubuntu 22.04)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-cuttlefish:
    name: Build and Upload Cuttlefish
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # ✨ 步骤 1: 修正了 GPG 密钥下载
      # ----------------------------------------------------
      - name: Install dependencies and Cuttlefish repo
        run: |
          sudo apt-get update
          
          # 1. 安装基础依赖
          sudo apt-get install -y git devscripts equivs config-package-dev debhelper-compat golang curl gpg
          
          # 2. 修正：添加 GPG 密钥（使用更健壮的两步法）
          #    -fL: -f (fail-fast on server errors), -L (follow redirects)
          echo "Downloading Cuttlefish GPG key..."
          curl -fL "https://cuttlefish.github.io/data/conf/google-cloud.gpg" -o "cuttlefish-key.gpg"
          
          # 3. 将下载的密钥文件解密到 keyring 目录
          #    (只有在 curl 成功后才会运行到这一步)
          sudo gpg --dearmor -o /usr/share/keyrings/cuttlefish-archive-keyring.gpg < cuttlefish-key.gpg
          
          # 4. 添加 Cuttlefish apt 仓库
          echo "deb [signed-by=/usr/share/keyrings/cuttlefish-archive-keyring.gpg] https://cuttlefish.github.io/data/debian stable main" | sudo tee /etc/apt/sources.list.d/cuttlefish.list
          
          # 5. 再次更新 apt 列表以识别新仓库
          sudo apt-get update

      # --- 后续步骤保持不变 ---

      # 步骤 2: 克隆 Cuttlefish 仓库
      - name: Clone Cuttlefish repository
        run: git clone https://github.com/google/android-cuttlefish

      # 

      # 步骤 3: 构建 Cuttlefish 软件包
      - name: Build Cuttlefish packages
        run: tools/buildutils/build_packages.sh
        working-directory: ./android-cuttlefish

      # 步骤 4: 上传 .deb 文件
      - name: Upload Cuttlefish .deb artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cuttlefish-debs-ubuntu-22.04
          path: |
            ./android-cuttlefish/cuttlefish-base_*_*64.deb
            ./android-cuttlefish/cuttlefish-user_*_*64.deb
          retention-days: 7
