name: Build and Upload Cuttlefish (Ubuntu 22.04)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-cuttlefish:
    name: Build and Upload Cuttlefish
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # 步骤 1: 安装依赖 (已移除 golang)
      # ----------------------------------------------------
      - name: Install dependencies and Cuttlefish repo
        run: |
          sudo apt-get update
          
          # 1. 安装基础依赖 (已从此列表中移除 golang)
          sudo apt-get install -y git devscripts equivs config-package-dev debhelper-compat curl gpg
          
          # 2. 添加 Google Artifact Registry GPG 密钥
          sudo curl -fsSL "https://us-apt.pkg.dev/doc/repo-signing-key.gpg" -o "/etc/apt/trusted.gpg.d/artifact-registry.asc"
          sudo chmod a+r /etc/apt/trusted.gpg.d/artifact-registry.asc
          
          # 3. 添加 Artifact Registry 仓库 URL
          echo "deb https://us-apt.pkg.dev/projects/android-cuttlefish-artifacts android-cuttlefish main" | sudo tee -a /etc/apt/sources.list.d/artifact-registry.list
          
          # 4. 再次更新 apt 列表
          sudo apt-get update

      # ----------------------------------------------------
      # 步骤 2: ✨ 新增 - 安装特定版本的 Go
      # ----------------------------------------------------
      - name: Setup Go environment
        uses: actions/setup-go@v5
        with:
          # Cuttlefish 需要一个较新版本的 Go
          go-version: '1.22' 
          
      # 步骤 3: 克隆 Cuttlefish 仓库
      - name: Clone Cuttlefish repository
        run: git clone https://github.com/google/android-cuttlefish

      # 步骤 4: 构建 Cuttlefish 软件包
      # 现在 mk-build-deps 应该能找到 Go (1.22) 
      - name: Build Cuttlefish packages
        run: tools/buildutils/build_packages.sh
        working-directory: ./android-cuttlefish

      # 步骤 5: 上传 .deb 文件
      - name: Upload Cuttlefish .deb artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cuttlefish-debs-ubuntu-22.04
          path: |
            ./android-cuttlefish/cuttlefish-base_*_*64.deb
            ./android-cuttlefish/cuttlefish-user_*_*64.deb
          retention-days: 7
