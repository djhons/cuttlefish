name: Build and Upload Cuttlefish (Ubuntu 22.04)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-cuttlefish:
    name: Build and Upload Cuttlefish
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # ✨ 步骤 1: 修正 - 添加 Google Artifact Registry
      # ----------------------------------------------------
      - name: Install dependencies and Cuttlefish repo
        run: |
          sudo apt-get update
          
          # 1. 安装基础依赖
          sudo apt-get install -y git devscripts equivs config-package-dev debhelper-compat golang curl gpg
          
          # 2. 修正：从 Google Artifact Registry 下载新的 GPG 密钥
          echo "Downloading Cuttlefish GPG key from Google Artifact Registry..."
          sudo curl -fsSL "https://us-apt.pkg.dev/doc/repo-signing-key.gpg" -o "/etc/apt/trusted.gpg.d/artifact-registry.asc"
          
          # 3. 修正：确保密钥文件可读
          sudo chmod a+r /etc/apt/trusted.gpg.d/artifact-registry.asc
          
          # 4. 修正：添加新的 Artifact Registry 仓库 URL
          echo "deb https://us-apt.pkg.dev/projects/android-cuttlefish-artifacts android-cuttlefish main" | sudo tee -a /etc/apt/sources.list.d/artifact-registry.list
          
          # 5. 再次更新 apt 列表 (至关重要)
          # 这将使 apt 能够找到 'cuttlefish-common-build-deps' 等包
          sudo apt-get update

      # --- 后续步骤保持不变 ---

      # 步骤 2: 克隆 Cuttlefish 仓库
      - name: Clone Cuttlefish repository
        run: git clone https://github.com/google/android-cuttlefish

      # 步骤 3: 构建 Cuttlefish 软件包
      # 现在 mk-build-deps 应该可以正常工作了
      - name: Build Cuttlefish packages
        run: tools/buildutils/build_packages.sh
        working-directory: ./android-cuttlefish

      # 步骤 4: 上传 .deb 文件
      - name: Upload Cuttlefish .deb artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cuttlefish-debs-ubuntu-22.04
          path: |
            ./android-cuttlefish/cuttlefish-base_*_*64.deb
            ./android-cuttlefish/cuttlefish-user_*_*64.deb
          retention-days: 1
