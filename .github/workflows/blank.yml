name: Build and Upload Cuttlefish

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-cuttlefish:
    name: Build and Upload Cuttlefish
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- 修正过的步骤 ---
      - name: Install dependencies and Cuttlefish repo
        run: |
          sudo apt-get update
          
          # 1. 安装基础依赖 (确保 gpg 和 curl 已安装)
          sudo apt-get install -y git devscripts equivs config-package-dev debhelper-compat golang curl gpg
          
          # 2. 添加 Cuttlefish GPG 密钥
          curl -s https://cuttlefish.github.io/data/conf/google-cloud.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cuttlefish-archive-keyring.gpg
          
          # 3. 添加 Cuttlefish apt 仓库
          echo "deb [signed-by=/usr/share/keyrings/cuttlefish-archive-keyring.gpg] https://cuttlefish.github.io/data/debian stable main" | sudo tee /etc/apt/sources.list.d/cuttlefish.list
          
          # 4. 再次更新 apt 列表 (以便识别新仓库中的包)
          sudo apt-get update

      # --- 后续步骤不变 ---

      - name: Clone Cuttlefish repository
        run: git clone https://github.com/google/android-cuttlefish

      - name: Build Cuttlefish packages
        run: tools/buildutils/build_packages.sh
        working-directory: ./android-cuttlefish

      - name: Upload Cuttlefish .deb artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cuttlefish-debs
          path: |
            ./android-cuttlefish/cuttlefish-base_*_*64.deb
            ./android-cuttlefish/cuttlefish-user_*_*64.deb
          retention-days: 1

      # (可选) 在 Action 中安装以进行验证
      - name: Install cuttlefish-base
        run: sudo dpkg -i ./cuttlefish-base_*_*64.deb || sudo apt-get install -f -y
        working-directory: ./android-cuttlefish

      - name: Install cuttlefish-user
        run: sudo dpkg -i ./cuttlefish-user_*_*64.deb || sudo apt-get install -f -y
        working-directory: ./android-cuttlefish
